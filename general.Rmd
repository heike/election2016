---
title: "General Elections"
author: "Heike Hofmann"
date: "September 24, 2015"
output: html_document
---


```{r, echo=FALSE, fig.width=7, fig.height=5, message=FALSE}
library(XML)
library(lubridate)
library(plyr)
library(reshape2)
library(ggplot2)
library(RColorBrewer)

###############
#  functions
sub <- function(x, replace=c("--"), by=NA) {
  x <- as.character(x)
  idx <- which(x %in% replace)
  if (length(idx) > 0) x[idx] <- by
  x
}

plotCandidates <- function(rcp.gen) {
  tables <- readHTMLTable(rcp.gen)
  dims <- ldply(tables, function(x) if (is.null(x)) c(0,0) else dim(x))
  gen <- data.frame(tables[[which.max(dims[,2])]])
  gen <- gen[nrow(gen):1,]
  gen <- subset(gen, Poll != "RCP Average")
  
  genNA <- lapply(gen, sub)
  write.csv(genNA, "temp.csv", row.names=FALSE)
  gen <- read.csv("temp.csv")
  gen$year <- 2015
  
  dates <- strsplit(as.character(gen$Date), split=" - ")
  d2 <- ldply(dates, function(x) data.frame(
    startDate = mdy(paste(x[1],"15", sep="/")),
    endDate = mdy(paste(x[2],"15", sep="/"))))
  year(d2$startDate) <- gen$year
  year(d2$endDate) <- gen$year
  
  gen <- data.frame(gen, d2)
    demID <- grep("..D.", names(gen), fixed=TRUE)
    repID <- grep("..R.", names(gen), fixed=TRUE)
    
  gen$value <- gen[,demID] - gen[,repID]
  democrat <- names(gen)[demID]
  republican <- names(gen)[repID]
  yrange <- max(abs(gen$value), na.rm=TRUE) *c(-1,1)
  by <- 5
  if (max(yrange) > 10) by <- 10
  yscale <- seq(0, max(yrange), by=by)
  yscale <- unique(c(-yscale, yscale))
  
  cols <- c(brewer.pal(12, name="Paired"), "grey30", "grey50", "grey70")

  sm_layer <- NULL
  if (nrow(gen) > 15) {
      sm_layer <- geom_smooth(aes(x=endDate, y=value, group=1), 
                              colour="grey30", se=FALSE, size=.75, data=gen) 
  }
  ggplot(aes(colour=Poll), data=gen) +
    geom_hline(yintercept=0, colour="grey80") +
    sm_layer + 
    geom_point(aes(x=endDate, y=value), size=2.5, alpha=0.9) + 
    geom_segment(aes(x=startDate, xend=endDate, yend=value, y=value), size=1.5) +
    scale_colour_manual(values=cols) + theme_bw() +
    theme(legend.position="bottom") + xlab("Date of Poll") + 
    annotate("text", x=max(gen$endDate), y=yrange[2], label=democrat, 
             colour="grey50", size=7) +
    annotate("text", x=max(gen$endDate), y=yrange[1], label=republican, 
             colour="grey50", size=7) +
    scale_y_continuous("Percent Difference", breaks=yscale, 
                       labels=abs(yscale), limits=yrange)
}
############
plotCandidates("http://www.realclearpolitics.com/epolls/2016/president/us/general_election_trump_vs_clinton-5491.html")

plotCandidates("http://www.realclearpolitics.com/epolls/2016/president/us/general_election_fiorina_vs_clinton-5470.html")

plotCandidates("http://www.realclearpolitics.com/epolls/2016/president/us/general_election_bush_vs_clinton-3827.html")

plotCandidates("http://www.realclearpolitics.com/epolls/2016/president/us/general_election_bush_vs_clinton-3827.html")

plotCandidates("http://www.realclearpolitics.com/epolls/2016/president/us/general_election_trump_vs_biden-5568.html")

plotCandidates("http://www.realclearpolitics.com/epolls/2016/president/us/general_election_bush_vs_biden-3828.html")

plotCandidates("http://www.realclearpolitics.com/epolls/2016/president/us/general_election_trump_vs_sanders-5565.html")

plotCandidates("http://www.realclearpolitics.com/epolls/2016/president/us/general_election_bush_vs_sanders-5563.html")



```